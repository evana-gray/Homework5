---
title: "homework5"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(psych)
```

# Read in UCI Data

Initially read in data using provided code including the merge-join based on original 13 variables.

```{r}
#use r code provided in download... already suitable to read files from project folder
d1=read.table("student-mat.csv",sep=";",header=TRUE)
d2=read.table("student-por.csv",sep=";",header=TRUE)

d3=merge(d1,d2,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet"))
#print(nrow(d3)) # 382 students

```

# Tidyverse Read in Data

Use tidyverse functions to read in data and use original 13 suggested variables as inner join criteria. This leads to a many:many relationship which suggests the 13 field combinations are not specific enough.

-   The Mat dataset shows student demographic information and test scores from a mathematics class. This is the "LEFT" dataset in the join and data elements exclusive to it end in ".x"

-   The Por dataset shows student demographic information and test scores from a Portuguese class. This is the "RIGHT" dataset in the join and data elements exclusive to it end in ".y"

```{r}
#same work done using tidyverse functions
mat <- as_tibble(read_delim("student-mat.csv", delim = ";", col_names = TRUE))
por <- as_tibble(read_delim("student-por.csv", delim = ";", col_names = TRUE))

#result is many:many join - these fields are not specific enough
InitialJoin <- inner_join(mat, por, by = join_by("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet"))



```

# Assign factors for categorical variables of interest

```{r}

mat <-  mat |>
  mutate(
    health_f = factor(health,levels = c(seq(1:5)),
                     labels = c("very bad","bad","neutral","good","very good")),
    Walc_f = factor(Walc,levels = c(seq(1:5)),
                    labels = c("very low", "low", "0-avg","high","very high")),
    Dalc_f = factor(Dalc,levels = c(seq(1:5)),
                    labels = c("very low", "low", "0-avg","high","very high")),
    studytime_f = factor(studytime,levels = c(seq(1:4)),
                    labels = c("<2 hours", "2-5 hours", "5-10 hours",">10 hours")),
    sex_f = factor(sex,levels = c("M","F"),
                    labels = c("Male","Female")),
    school_f = factor(school,levels = c("GP","MS"),
                    labels = c("Gabriel Pereira","Mousinho da Silveira")),
    address_f = factor(address,levels = c("R","U"),
                    labels = c("Rural","Urban"))
  )

por <-  por |>
  mutate(
    health_f = factor(health,levels = c(seq(1:5)),
                     labels = c("very bad","bad","neutral","good","very good")),
    Walc_f = factor(Walc,levels = c(seq(1:5)),
                    labels = c("very low", "low", "0-avg","high","very high")),
    Dalc_f = factor(Dalc,levels = c(seq(1:5)),
                    labels = c("very low", "low", "0-avg","high","very high")),
    studytime_f = factor(studytime,levels = c(seq(1:4)),
                    labels = c("<2 hours", "2-5 hours", "5-10 hours",">10 hours")),
    sex_f = factor(sex,levels = c("M","F"),
                    labels = c("Male","Female")),
    school_f = factor(school,levels = c("GP","MS"),
                    labels = c("Gabriel Pereira","Mousinho da Silveira")),
    address_f = factor(address,levels = c("R","U"),
                    labels = c("Rural","Urban"))
  )



```

# Final Join

This inner join uses all variables EXCEPT G1, G2, G3, paid and absences. The four factor variables are also excluded as join criteria.

```{r}
#join by every field except response variables
#no many:many join message
combined <- as_tibble(
  inner_join(mat, por, 
             by = names(select(mat,everything(), -c("G1","G2","G3","paid","absences", "health_f", "Walc_f", "Dalc_f", "studytime_f","sex_f", "school_f", "address_f")))
             )
  )

#clear initial imports out of environment
rm(d1,d2,d3,InitialJoin)
```

# Initial EDA

These analyses demonstrate:

1.  The full combined dataset.
2.  Descriptive statistics for all dataset variables. Some of the variables are coded in such a way that many statistics such as the "address" field having a numeric mean.
3.  Two methods are used to find missing data values - there are no missing values for any variable in the dataset.

```{r}
#view tibble - observe sample of values
combined

#use describe() to get descriptive statistics on all variables
psych::describe(combined)

#determine missing rate using function in lecture
##no missing values identified throughout entire dataset
colSums(is.na(combined))

sum_na <- function(column){
  sum(is.na(column))
}

na_counts <- combined |>
  summarize(across(everything(), sum_na))
na_counts

```

# Contingency Tables

## Simple one way contingency

This one way contingency table shows the number of students residing in each address type (R= Rural / U=Urban)

```{r}
#one way contingency table
table(combined$address_f.x)

```

## Two way and three way contingency

Below are a two way and a three way contingency table. The two way shows the mother's job by address type. The three way contingency table shows the first two way contingency table with its values split by a 3rd dimension the presence of family educational support (yes/no).

```{r}
#two way contingency table 
table(combined$Mjob, combined$address_f.x)

#three way contingency table
table(combined$Mjob, combined$address_f.x, combined$famsup)

```

## Conditional two way table

These two contingency tables demonstrate multiple ways to subset contingency table data - the first uses a filter function, and the second filters based on the 2nd item of the 3rd array dimension. Both methods return identical data.

```{r}

#conditional two way table - observe study time by sex where address is rural 
#create data subset before table()
ruraldata <- combined |> 
  filter(address == "U") 
table(ruraldata$sex_f.x, ruraldata$studytime_f.x)


#conditional two way table - observe study time by sex where address is urban
twoway_2 <- table(combined$sex_f.x, combined$studytime_f.x, combined$address_f.x)
twoway_2[,,2] #selecting for urban [sex row, study time column,rural/urban]
```

## dplyr contingency table

Dplyr group_by and summarize functions are used to create counts by weekly alcohol use and health status. This original structure included a row for each combination of the two categorical variables. Pivot wider creates new columns from repeating values from an existing column - Walc_f.x.

```{r}
#observe count of health status across levels of reported weekly alcohol use
#reorient data using pivot_wider()
combined |>
  group_by(health_f.x, Walc_f.x) |>
  summarize(count = n()) |>
  pivot_wider(names_from = health_f.x, values_from = count)
```

# Initial Bar Plots

## Compare stacked with side by side

Two simple bar plots were created to demonstrate the different ways multiple categorical variables can be shown in a bar plot. One shows the total counts for the two groups stacked on top of each other. The other shows the two groups side-by-side, which can be easier to quickly read and interpret.

```{r}

#stacked bar plot
ggplot(combined, aes(x = health_f.x, fill = address_f.x)) +
  geom_bar() +
  labs(title = "Stacked Bar Chart",x = "Health", y = "Observations") +
  theme_light()

#side by side bar plot
ggplot(combined, aes(x = health_f.x, fill = address_f.x)) +
  geom_bar(position = "dodge") +
  labs(title = "Side by Side Bar Chart", x = "Health", y = "Observations") + 
  theme_light()

```

# Numeric Variables

5 measures of center and spread: mean, median, variance, standard deviation, and interquartile range were used to describe three numeric variables (student age, mathematics class absences, and the final G3 mathematics assessment score.

```{r}
#Measures of Center and Spread
fxlist <- list("mean" = mean, "median" = median, "var" = var, "sd" = sd, "IQR" = IQR)

MeasureAndSpread1 <- list(
combined |> summarize(across(age,.fns = fxlist,.names = "{.col}_{.fn}")),
combined |> summarize(across(absences.x,.fns = fxlist,.names = "{.col}_{.fn}")),
combined |> summarize(across(G3.x,.fns = fxlist,.names = "{.col}_{.fn}"))
)

MeasureAndSpread1

```

The tables below take a similar approach to the first but have added a grouping variable, school. This helps one understand differences in students across the schools.

```{r}
#Overall age absences and G3 across school


MeasureAndSpread2 <- list(
combined |> group_by(school_f.x)|> summarize(across(age,.fns = fxlist,.names = "{.col}_{.fn}")),
combined |> group_by(school_f.x)|> summarize(across(absences.x,.fns = fxlist,.names = "{.col}_{.fn}")),
combined |> group_by(school_f.x)|> summarize(across(G3.x,.fns = fxlist,.names = "{.col}_{.fn}")))

MeasureAndSpread2
```

Below the same information is repeated with a subset for the GP school.

```{r}
#subset for GP school
combinedgp <- filter(combined,school == "GP")
MeasureAndSpread3 <- list(
combinedgp |> summarize(across(age,.fns = fxlist,.names = "{.col}_{.fn}")),
combinedgp |> summarize(across(absences.x,.fns = fxlist,.names = "{.col}_{.fn}")),
combinedgp |> summarize(across(G3.x,.fns = fxlist,.names = "{.col}_{.fn}"))
)

MeasureAndSpread3
```

Two categorical values: reason the student chose their school and the school they chose, are used to group descriptive statistics.

```{r}
#Measures across two variables: reason for choosing school and the school that was chosen. 
MeasureAndSpread4 <- list(
combined |> group_by(reason, school)|> summarize(across(age,.fns = fxlist,.names = "{.col}_{.fn}")),
combined |> group_by(reason, school)|> summarize(across(absences.x,.fns = fxlist,.names = "{.col}_{.fn}")),
combined |> group_by(reason, school)|> summarize(across(G3.x,.fns = fxlist,.names = "{.col}_{.fn}"))
)

MeasureAndSpread4
```

# Correlation Matrix

## correlation matrix of three target variables

The correlation matrix below shows how three numeric variables: age, mathematics absences, and final mathematics assessment are correlated with each other. There are no particularly strong linear associations between the three variables.

```{r}

combined |>
  select(age, absences.x, G3.x) |>
  cor()

```

## correlation matrix for all numeric variables in combined dataset

For reference, a correlation matrix can easily be computed for all numeric variables in the dataset by taking advantage of the where(is.numeric) function. To properly interpret these some of these correlations prior knowledge is needed as some are discrete numerical values and others may be coded numeric values that represent categorical or ordinal data.

```{r}

combined |>
  select(where(is.numeric)) |>
  cor()

```

# Scatterplot Analyses

## Scatterplot 1 Math G3 Scores by Math Absences by school

In the scatterplot below, each dot represents a student's unique combination of school they attend, mathematics absences and math G3 score. What school they attended is noted by their dot color.

Most students had below 20 absences, and those with more tended to score worse on the assessment. Students in the MS school had fewer absences as a group than those in the GP school and they account for none of the outliers.

```{r}
gs <- ggplot(combined, aes(x = absences.x, y = G3.x, color = school_f.x))
gs + geom_point() + geom_jitter(alpha = 0.5) + labs(x = "Math Absences", y = "Math G3 Score")
```

## Scatterplot 2 Math G3 Scores by Math G1 Scores by Sex

This scatterplot shows a strong linear relationship between the mathematics G1 score and the mathematics G3 score. Dot color denotes sex. The relationship appears consistent across sex.

```{r}
gs2 <- ggplot(combined, aes(x = G1.x, y = G3.x, color = sex_f.x))
gs2 + geom_point() + geom_jitter(alpha = 0.5) + labs(x = "Math G1 Score", y = "Math G3 Score")
```

## Scatterplot 2 Math G3 Scores by Math G2 Scores by Sex

Below you can see the linear relationship between G3 and G2 is even stronger than G3 and G1 in the previous plot. The data points are bunched much closer to each other.

```{r}
gs2 <- ggplot(combined, aes(x = G2.x, y = G3.x, color = sex_f.x))
gs2 + geom_point() + geom_jitter(alpha = 0.5) + labs(x = "Math G1 Score", y = "Math G3 Score")
```

## Scatterplot with facet

This plot shows a different presentation of the above information. Instead of each dot being a distinct color - males and females have their own scatterplot side by side. The male scores appear slightly more widely dispersed than the female scores.

```{r}
gs2 <- ggplot(combined, aes(x = G1.x, y = G3.x))
gs2 + geom_point() + geom_jitter(alpha = 0.5) + labs(x = "Math G1 Score", y = "Math G3 Score") + facet_wrap(~sex_f.x) + theme_light()
```

## Scatterplot with multi categorical facet

More than one categorical value can be used to research the G1 to G3 relationship. The 4x2 plot below shows this relationship by sex and by math study time. The same positive linear relationship is seen across all plots though fewer students studied more than 10 hours than any other study time category.

```{r}
gs3 <- ggplot(combined, aes(x = G1.x, y = G3.x))
gs3 + geom_point() + geom_jitter(alpha = 0.5) + labs(x = "Math G1 Score", y = "Math G3 Score") + 
      facet_grid(rows = vars(studytime_f.x), cols = vars(sex_f.x))
```
